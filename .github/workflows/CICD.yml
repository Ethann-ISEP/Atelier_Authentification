name: Industrialisation continue sur le serveur Alwaysdata

on:
  push:
    branches: [ "main" ]

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: D√©ploiement et Configuration S√©curit√©
        uses: appleboy/ssh-action@master
        # On d√©finit la variable d'environnement ici pour qu'elle soit accessible
        env:
          HTPASSWD_CONTENT: ${{ secrets.HTPASSWD_CONTENT }}
        with:
          host: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # On indique au script d'utiliser cette variable
          envs: HTPASSWD_CONTENT
          script: |
            # 1. D√©finition des variables
            REPO_URL="https://github.com/${{ github.repository }}.git"
            TARGET_DIR="$HOME/www"
            CLONE_DIR="$HOME/clone_temp"

            # 2. Nettoyage et Clonage propre
            rm -rf $CLONE_DIR
            git clone $REPO_URL $CLONE_DIR

            # 3. Synchronisation (Copie des fichiers vers www)
            mkdir -p $TARGET_DIR
            
            if [ -d "$CLONE_DIR" ]; then
              rsync -r --delete --exclude '.git' $CLONE_DIR/ $TARGET_DIR/
              rm -rf $CLONE_DIR
              echo "‚úÖ Site mis √† jour avec succ√®s."
            else
              echo "‚ùå Erreur : Le clonage a √©chou√©."
              exit 1
            fi

            # --- PARTIE EXERCICE 3 : GESTION DU .HTPASSWD ---
            
            echo "üîí Configuration de la s√©curit√© (Basic Auth)..."
            
            # Cr√©ation du dossier sp√©cifique atelier1
            mkdir -p $TARGET_DIR/atelier1
            
            # --- LA CORRECTION EST ICI ---
            # Utilisation de guillemets simples ' ' pour prot√©ger les caract√®res sp√©ciaux ($)
            echo '${{ secrets.HTPASSWD_CONTENT }}' > $TARGET_DIR/atelier1/.htpasswd
            
            # V√©rification
            if [ -f "$TARGET_DIR/atelier1/.htpasswd" ]; then
                echo "‚úÖ Fichier .htpasswd cr√©√© avec succ√®s."
            else
                echo "‚ùå Erreur lors de la cr√©ation du fichier .htpasswd"
                exit 1
            fi
